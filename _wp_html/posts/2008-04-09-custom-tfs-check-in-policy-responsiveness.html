I've used several third party Check In Policies for Team Foundation Server with both TFS2005 and 2008 and I've dabbled in writing my own too. One thing I noticed with most of them, is that they don't appear to respond to actions in the VS Pending Changes window as readily as the standard Microsoft policies.

I recently followed <a href="http://twitter.com/jburger" target="_blank">Jim's</a> example <a href="http://cultivatingcode.com/2008/03/14/option-strict-on-check-in-policy/" target="_blank">Option Strict Check In Policy</a> to write my own policy to prevent checking in code with the <a href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=311689" target="_blank">DataSet Designer ConnectionState Bug</a>. The policy would always correctly evaluate when clicking the Check In button but the Policy Warnings tab didn't always update automatically when Source Files list changed.

I decided it was time to dig deeper and find out why the standard policies work nicely when compared to the custom ones. After a few minutes with Reflector I discovered there were a few more things to do beyond the <a href="http://msdn2.microsoft.com/en-us/library/bb668980.aspx" target="_blank">instructions in the MSDN article</a> to create a responsive custom policy.

The <a href="http://msdn2.microsoft.com/en-us/library/microsoft.teamfoundation.versioncontrol.client.policybase.aspx" target="_blank">PolicyBase class</a>, from which your custom policy should inherit, gets passed an instance of <a href="http://msdn2.microsoft.com/en-us/library/microsoft.teamfoundation.versioncontrol.client.ipendingcheckin.aspx" target="_blank">IPendingCheckin</a> to its <a href="http://msdn2.microsoft.com/en-us/library/microsoft.teamfoundation.versioncontrol.client.policybase.initialize.aspx" target="_blank">Initialize</a> method which it persists and is made available to your subclass via a protected <a href="http://msdn2.microsoft.com/en-us/library/microsoft.teamfoundation.versioncontrol.client.policybase.pendingcheckin.aspx" target="_blank">PendingCheckin</a> property. The IPendingCheckin instance exposes several other objects with events that you can handle to be notified when changes relevant to your policy occur.

The methodology that worked for me was to override Initialize and register the event handler and override Dispose also to remove the handler at the end. All the handler does, after checking the base class isn't disposed, is to call the custom policy's Evaluate function and raise the base's <a href="http://msdn2.microsoft.com/en-us/library/microsoft.teamfoundation.versioncontrol.client.policybase.policystatechanged.aspx" target="_blank">PolicyStateChanged</a> event.

Sample code for a policy dependent on the Source Files list, like the Option Strict policy and the ConnectionState Bug policy, follows:

<span style="font-size:11px;color:black;font-family:Courier New;background-color:transparent;"><span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Public</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Overrides</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Sub</span> Initialize(<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">ByVal</span> pendingCheckin <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">As</span> IPendingCheckin)
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> MyBase</span>.Initialize(pendingCheckin)
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> AddHandler</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">MyBase</span>.PendingCheckin.PendingChanges.CheckedPendingChangesChanged, _
<span style="font-size:11px;color:red;font-family:Courier New;background-color:transparent;"> <span style="color:#0000ff;">AddressOf</span></span> CheckedPendingChangesChanged
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">End</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Sub</span></span>

<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Private</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Sub</span> CheckedPendingChangesChanged(<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">ByVal</span> sender <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">As</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Object</span>, <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">ByVal</span> e <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">As</span> EventArgs)
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> If</span> <span style="font-size:11px;color:red;font-family:Courier New;background-color:transparent;"><span style="color:#0000ff;">Not</span></span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">MyBase</span>.Disposed <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Then</span>
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> Dim</span> failures <span style="font-size:11px;color:red;font-family:Courier New;background-color:transparent;"><span style="color:#000000;">=</span></span> Evaluate()
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> MyBase</span>.OnPolicyStateChanged(failures)
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> End</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">If</span>
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">End</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Sub</span>

<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Public</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Overrides</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Sub</span> Dispose()
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> RemoveHandler</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">MyBase</span>.PendingCheckin.PendingChanges.CheckedPendingChangesChanged, _
<span style="font-size:11px;color:red;font-family:Courier New;background-color:transparent;"> <span style="color:#0000ff;">AddressOf</span></span> CheckedPendingChangesChanged
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;"> MyBase</span>.Dispose()
<span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">End</span> <span style="font-size:11px;color:blue;font-family:Courier New;background-color:transparent;">Sub</span>