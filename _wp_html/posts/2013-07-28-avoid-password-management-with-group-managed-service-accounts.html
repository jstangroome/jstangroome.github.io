A common problem when managing deployments of applications, manual or automated, is where to securely store the passwords for service accounts used by Windows Services, IIS Application Pools, and Scheduled Tasks in each of the environments the applications are deployed to.

With Windows Server 2008 R2, the first step to simplifying this problem was introduced in the form of <a href="http://technet.microsoft.com/en-us/library/dd560633(v=ws.10).aspx">Managed Service Accounts</a>. Unfortunately they suffered from the limitation of being restricted to a single computer so you couldn't use them for load-balanced web applications, for example. It was also a challenge to get them to work for anything other than Windows Services in Server 2008.

Now, with Windows Server 2012, these accounts have matured and become <a href="http://technet.microsoft.com/en-us/library/hh831782.aspx">Group Managed Service Accounts</a> or gMSAs. They can be used to run processes on multiple machines and work well with IIS Application Pools and Scheduled Tasks too.

I had an early opportunity to experiment with gMSAs when Server 2012 was still a Release Candidate but more recently I've been fortunate to use them extensively for a multitude of applications on my current client engagement so I thought I'd share my experience with the benefits and some of gotchas.
<h2>How secure are Group Managed Service Accounts?</h2>
At the very least, they are more secure than using a domain user account for a service, because they remove the human-element, but there is more:
<ul>
	<li>They are based on a very similar model to Domain-joined Computer Accounts (they in fact inherit from the Computer Account class in the Active Directory schema).</li>
	<li>The passwords are automatically changed every 30 days (by default) and the infrastructure ensures all the necessary computers are updated.</li>
	<li>The passwords are 120-characters and generated by the Domain Controllers based on a root key, the account SID, and the current time.</li>
	<li>Like a computer account, only the Windows authentication infrastructure can access the password, and it is quite difficult (if not impossible) for a human to access the password.</li>
	<li>They are explicitly denied the Interactive Logon right so a human couldn't logon with one even if they could acquire the password.</li>
	<li>The Domain Administrator controls which computers are allowed to run processes using the gMSA's credentials.</li>
	<li>They are least privilege accounts by default, just like a standard domain user, until they are explicitly granted additional group memberships or privileges.</li>
</ul>
<h2>What do you need to use them?</h2>
<ul>
	<li>You'll need at least one Windows Server 2012 Domain Controller in the domain where applications will run as gMSAs.</li>
	<li>You'll need to upgrade the AD schema for Server 2012 too.</li>
	<li>You'll need to <a href="http://technet.microsoft.com/en-us/library/jj128430.aspx">create the root KDS key</a> used to generate the gMSA passwords and wait for it to replicate</li>
	<li>The computers where the applications will run will need to be Windows Server 2012 or later too. However, you can grant gMSAs access to resources on older OSes because appears just like Computer accounts in AD.</li>
	<li>Familiarity with PowerShell because gMSAs are mostly managed via Cmdlets and have very little GUI support.</li>
</ul>
<h2>How do you use them for a Windows Service?</h2>
<ol>
	<li>Ensure the "PrincipalsAllowedToRetrieveManagedPassword" attribute for the gMSA includes the Computer Account where the service will run. (Be careful with tab completion and the "PrincipalsAllowedToDelegateToAccount" attribute.)</li>
	<li>Use the <a href="http://technet.microsoft.com/en-us/library/hh852196.aspx">Install-ADServiceAccount</a> cmdlet to prepare the account on the computer where the service will run.</li>
	<li>Use "sc.exe" or the Services management console to specify the gMSA to use to run the service. Leave the password blank. If you use the <a href="http://msdn.microsoft.com/en-us/library/system.serviceprocess.serviceprocessinstaller.aspx">ServiceProcessInstaller </a>class in a .NET assembly (typically combined with <a href="http://msdn.microsoft.com/en-us/library/50614e95.aspx">installutil.exe</a>), it <a href="https://connect.microsoft.com/VisualStudio/feedback/details/795196/service-process-installer-should-support-virtual-service-accounts">is not possible to specify a gMSA account</a>, but it is possible to hack the private "haveLoginInfo" field to true via reflection to make it work. PowerShell's <a href="http://technet.microsoft.com/en-us/library/hh849830.aspx">New-Service cmdlet</a> <a href="https://connect.microsoft.com/PowerShell/feedback/details/795224/new-service-should-accept-virtual-or-managed-service-accounts">also won't handle gMSAs</a>.</li>
</ol>
<h2>How do you use them for an IIS Application Pool?</h2>
<ol>
	<li>The same as steps 1 and 2 above for a Windows Service.</li>
	<li>Use the SAM Account Name format (eg <em>DOMAIN\Name$</em>) to specify the gMSA using the IIS Manager, <a href="http://technet.microsoft.com/en-us/library/jj635852.aspx">appcmd.exe</a>, or the <a href="http://technet.microsoft.com/en-us/library/ee807821.aspx">Set-WebConfigurationProperty</a> cmdlet and leave the password blank. IIS doesn't appear to accept a gMSA specified via the User Principal Name format (eg <em>longname@domain.fqdn</em>).</li>
</ol>
<h2>How do you use them for a Scheduled Task?</h2>
<ol>
	<li>Again, the same as steps 1 and 2 above for a Windows Service.</li>
	<li>Use the <a href="http://technet.microsoft.com/en-us/library/jj649825.aspx">New-ScheduledTaskPrincipal</a> cmdlet to specify the gMSA account to use (<a href="http://blogs.technet.com/b/askpfeplat/archive/2012/12/17/windows-server-2012-group-managed-service-accounts.aspx">more details here</a>). The Task Scheduled management console and schtasks.exe won't accept a gMSA account.</li>
</ol>
<h2>General issues:</h2>
<ul>
	<li>By default the <a href="http://technet.microsoft.com/en-us/library/hh852236.aspx">New-ADServiceAccount</a> cmdlet used to create a gMSA will limit the account name to a maximum of 15 characters and won't set the User Principal Name (UPN). If you want to use a longer name, use the <strong>-SamAccountName</strong> parameter to specify the abbreviated name and use the <strong>-OtherAttributes</strong> parameter <a href="http://serverfault.com/questions/517136/how-do-i-use-long-names-to-refer-to-group-managed-service-accounts-gmsa">to specify the UPN</a>.</li>
	<li>Because gMSAs are explicitly denied the Interactive Logon right, they can't be used to access other systems which impersonate users interactively. SQL Server Reporting Services is one example where an application running as a gMSA will need to provide alternate credentials to connect.</li>
	<li>Avoiding the need to manage passwords ourselves is a major convenience of Group Managed Service Accounts and this involves a security trade-off. Once a Domain Administrator adds a computer, for example "SERVERA", to a gMSA'sÂ PrincipalsAllowedToRetrieveManagedPassword list, all local Administrators of SERVERA can now configure any service, apppool, or task to run as that gMSA. If you don't trust the sysadmins of SERVERA or the other applications on SERVERA, this could be provide a mechanism to escalate network privileges.</li>
</ul>
Given the need for environment of new server OSes, account name length limitations, and using the command-line instead of a GUI to configure everything, are gMSAs worth it. For me, it has been a resounding "Yes!" but I have a strong personal distaste for password management, especially in heavily automated Continuous Delivery scenarios. I also prefer to run each application in its own virtual machine wherever feasible.