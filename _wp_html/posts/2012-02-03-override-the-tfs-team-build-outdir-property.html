<strong>Update: <a title="Override the TFS Team Build OutDir property in .NET 4.5" href="http://blog.stangroome.com/2012/05/10/override-the-tfs-team-build-outdir-property-net-4-5/">with .NET 4.5 there is an easier way</a>.</strong>

A very common complaint from users of Team Foundation Server's build system is that it changes the folder structure of the project outputs. By default Visual Studio puts all the files in each project's respective /bin/ or /bin/&lt;configuration&gt;/ folder but Team Build just uses a flat folder structure putting all the files in the drop folder root or, again, a /&lt;configuration&gt;/ subfolder in the drop folder, with all project outputs mixed together.

Additionally because Team Build achieves this by setting the OutDir property via the MSBuild.exe command-line combined with<a href="http://blogs.msdn.com/b/aaronhallberg/archive/2007/07/16/msbuild-property-evaluation.aspx"> MSBuild's property precedence</a> this value cannot easily be changed from within MSBuild itself and the popular solution is to <a href="http://blogs.msdn.com/b/jimlamb/archive/2010/04/13/customizableoutdir-in-tfs-2010.aspx">edit the Build Process Template *.xaml file to use a different property name</a>. But I prefer not to touch the Workflow unless <strong>absolutely</strong> necessary.

Instead, I use both the <a href="http://sedodream.com/2010/10/22/MSBuildExtendingTheSolutionBuild.aspx">Solution Before Target</a> and the <a href="http://msdn.microsoft.com/en-us/library/dd722601.aspx">Inline Task</a> features of MSBuild v4 to override the default implementation of the <a href="http://msdn.microsoft.com/en-us/library/z7f65y0d.aspx">MSBuild Task</a> used to build the individual projects in the solution. In my alternative implementation, I prevent the OutDir property from being passed through and I pass through a property called PreferredOutDir instead which individual projects can use if desired.

The first part, substituting the OutDir property for the PreferredOutDir property at the solution level is achieved simply by adding a new file to the directory your solution file resides in. This new file should be named following the pattern "before.&lt;your solution name&gt;.sln.targets", eg for a solution file called "Foo.sln" then new file would be "before.Foo.sln.targets". The contents of this new file should <a href="https://gist.github.com/1727206#file_before.the_solution.sln.targets">look like this</a>. Make sure this new file gets checked-in to source control.

The second part, letting each project control its output folder structure, is simply a matter of adding a line to the project's *.csproj or *.vbproj file (depending on the language). Locate the first &lt;PropertyGroup&gt; element inside the project file that doesn't have a Condition attribute specified, and the locate the corresponding &lt;/PropertyGroup&gt; closing tag for this element. Immediately above the closing tag add a line something like this:
<pre>&lt;OutDir Condition=" '$(PreferredOutDir)' != '' "&gt;$(PreferredOutDir)$(MSBuildProjectName)\&lt;/OutDir&gt;</pre>
In this example the project will output to the Team Build drop folder under a subfolder named the same as the project file (without the .csproj extension). You might choose a different pattern. Also, Web projects usually create their own output folder under a _PublishedWebSites subfolder of the Team Build drop folder, to maintain this behaviour just set the OutDir property to equal the PreferredOutDir property exactly.

You can verify if your changes have worked on your local machine before checking in simply by running MSBuild from the command-line and specifying the OutDir property just like Team Build does, eg:
<pre>msbuild Foo.sln /p:OutDir=c:\TestDropFolder\</pre>